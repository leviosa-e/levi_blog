# 性能分析

## 基本概念

通过对页面的各加载阶段耗时、资源加载、包体积、网络请求、性能 trace 等方面进行分析，找出页面性能瓶颈，并进行优化。

## 明确当前性能水位

重点关注以下指标，注意需要拆开安卓和 iOS 分别进行统计，因为双端的性能瓶颈可能并不相同：

- 秒开率；
- FMP；

## 各加载阶段耗时

![页面各加载阶段耗时](../../images/web-page-load-phases.png "页面各加载阶段耗时")

重点关注以下指标，注意需要拆开安卓和 iOS 分别进行统计，因为双端的性能瓶颈可能并不相同：

- DNS：考虑 DNS 预热进行优化；
- TCP：考虑 预建连 进行优化；
- Response：

  - 服务器问题：服务器响应时间较长，可能是由于服务器性能差、负载过高、或者网络延迟等问题。
  - 网络问题：客户端到服务器的网络延迟较高，可能是由于网络拥堵或带宽限制。
  - API 响应时间：如果页面依赖于第三方 API，API 的响应时间也可能影响总体响应时间。

  - 解决办法：
    - 检查服务器性能和负载。
    - 优化服务器配置和查询，减少响应时间。
    - 使用 CDN（内容分发网络）来降低网络延迟。

- Processing：

  - JavaScript 执行：页面中的 JavaScript 代码执行时间过长，可能是由于复杂的计算、长时间运行的脚本或者不优化的代码。
  - 浏览器渲染：浏览器需要进行复杂的计算来渲染页面，可能是由于大量的 DOM 操作或者 CSS 计算。
  - 解决办法：

    - 优化 JavaScript 代码，使用性能分析工具（如 Chrome DevTools）找出瓶颈。
    - 减少不必要的 DOM 操作和重绘。
    - 使用 Web Workers 来处理复杂的计算任务。

- DOM Parse：
  - HTML 文档结构复杂或者包含大量的节点，可能导致 DOM 解析时间较长；
  - 阻塞性的 JavaScript 脚本（如同步加载的脚本）可能会影响 DOM 解析；
- Resource Load：

  - 大文件：大型图像、视频或其他资源文件会增加加载时间。
  - 未优化的资源：资源文件未经过优化，可能导致下载速度慢。
  - 多个请求：同时请求过多的资源可能导致网络拥堵和加载延迟。
  - 解决办法：

    - 压缩和优化图像、视频等资源文件。
    - 合并和压缩 CSS、JavaScript 文件，减少请求次数。
    - 使用懒加载技术来延迟加载非关键资源。

## 资源加载

重点关注以下指标，注意需要拆开安卓和 iOS 分别进行统计，因为双端的性能瓶颈可能并不相同：

- 主模板/子资源离线化率；
- preload 命中率；

可能导致性能瓶颈的原因：

- 子包拆得过细，导致需要发起多次网络请求以获得子资源；

## 包体积

- 是否存在重复的依赖，项目里同时安装了不同版本的同一个依赖，可以通过 `package.json` 的 `resolution` 配置以统一依赖的版本；
- 主模板文件/JS 文件是否体积过大，可以考虑通过拆包进行优化，将首屏渲染依赖的代码单独拆成一个文件，其他与首屏无关的代码都可以延后再加载；

## 网络请求

- 对于首屏渲染依赖接口数据的页面，可以通过 prefetch 进行优化；

  - 关注 prefetch 命中率是否偏低：

    - 将 prefetch.js 文件离线化，并且关注离线化率是否偏低；
    - 优化 prefetch.js 文件体积，尽可能精简，减少文件加载时间，提升 prefetch 命中率；

- 首屏直出：缓存接口数据，在用户进入页面时先使用缓存数据进行直出渲染，等接口返回后再用真实数据进行局部更新；

  - 注意根据业务特性设定缓存时长，比如一些以月为维度访问的业务，缓存时长可以考虑设置为 30 天；（不过也需要考虑到过长的缓存时长导致影响用户体验和客诉上升）

## 性能 trace

通过 Google 提供的 perfetto 工具对页面进行单点性能分析，检查页面加载过程中是否存在不合理的长任务，或其他造成线程阻塞的情况；
